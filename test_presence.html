<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>User Presence System Test</title>
    <link rel="stylesheet" href="styles.css">
    <style>
        .test-controls {
            position: fixed;
            top: 10px;
            right: 10px;
            background: #202c33;
            padding: 15px;
            border-radius: 8px;
            z-index: 1000;
            max-width: 280px;
        }
        .test-controls h3 {
            margin: 0 0 10px 0;
            color: #00a884;
        }
        .test-controls button {
            display: block;
            width: 100%;
            margin: 5px 0;
            padding: 8px;
            background: #2a3942;
            color: #e9edef;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 12px;
        }
        .test-controls button:hover {
            background: #384e5a;
        }
        .presence-info {
            font-size: 11px;
            color: #8696a0;
            margin: 10px 0;
            padding: 8px;
            background: #0b141a;
            border-radius: 5px;
            max-height: 150px;
            overflow-y: auto;
        }
        .presence-info div {
            margin: 2px 0;
        }
        .online { color: #00a884; }
        .offline { color: #8696a0; }
    </style>
<script src="https://sites.super.myninja.ai/_assets/ninja-daytona-script.js"></script>
</head>
<body>
    <div class="test-controls">
        <h3>Presence Test</h3>
        <button onclick="simulateUserOnline('i')">Simulate 'i' Online</button>
        <button onclick="simulateUserOffline('i')">Simulate 'i' Offline</button>
        <button onclick="simulateUserOnline('x')">Simulate 'x' Online</button>
        <button onclick="simulateUserOffline('x')">Simulate 'x' Offline</button>
        <button onclick="simulateTimePass()">Simulate Time Passing</button>
        <button onclick="clearSimulation()">Clear Simulation</button>
        
        <div class="presence-info" id="presence-log">
            <div>Presence log will appear here...</div>
        </div>
    </div>

    <div id="initial-user-selection" style="display: flex;">
        <h1>Who are you chatting as?</h1>
        <div class="user-buttons">
            <button data-user="i">Chat as: i</button>
            <button data-user="x">Chat as: x</button>
        </div>
        <p>(Select a user to see presence status)</p>
    </div>

    <div id="chat-container" style="display: none;">
        <div id="header-bar">
            <span id="my-user-id-display" class="user-id"></span>
            <span id="other-user-status" class="status-offline"></span>
        </div>
        <ul id="messages"></ul>
        <form id="form" action="">
            <input type="file" id="photo-input" accept="image/*,video/*,application/pdf" style="display: none;">
            <button id="photo-button" type="button" aria-label="Upload photo or file">
                <svg viewBox="0 0 24 24" width="24" height="24"><path fill="currentColor" d="M12 7c-2.76 0-5 2.24-5 5s2.24 5 5 5 5-2.24 5-5-2.24-5-5-5zm0 8c-1.66 0-3-1.34-3-3s1.34-3 3-3 3 1.34 3 3-1.34 3-3 3zM20 5h-3.17L15 3H9L7.17 5H4c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 14H4V7h4.05l1.84-2h4.24l1.84 2H20v12z"/></svg>
            </button>
            <textarea id="input" autocomplete="off" placeholder="Type a message..." rows="1"></textarea>
            <button id="send-button" type="submit" aria-label="Send message">
                <svg viewBox="0 0 24 24" width="24" height="24"><path fill="currentColor" d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"/></svg>
            </button>
        </form>
    </div>

    <script>
        // Mock presence data for simulation
        let mockPresence = {
            'i': { isOnline: false, lastSeen: null },
            'x': { isOnline: false, lastSeen: null }
        };

        let currentUser = null;
        let simulationInterval = null;

        function logPresence(message, type = 'info') {
            const log = document.getElementById('presence-log');
            const timestamp = new Date().toLocaleTimeString();
            const div = document.createElement('div');
            div.innerHTML = `<span class="${type}">[${timestamp}] ${message}</span>`;
            log.appendChild(div);
            log.scrollTop = log.scrollHeight;
        }

        function simulateUserOnline(userId) {
            mockPresence[userId].isOnline = true;
            mockPresence[userId].lastSeen = new Date().toISOString();
            updatePresenceDisplay();
            logPresence(`User '${userId}' is now online`, 'online');
        }

        function simulateUserOffline(userId) {
            mockPresence[userId].isOnline = false;
            mockPresence[userId].lastSeen = new Date().toISOString();
            updatePresenceDisplay();
            logPresence(`User '${userId}' is now offline`, 'offline');
        }

        function simulateTimePass() {
            const timeAgo = (timestamp) => {
                if (!timestamp) return null;
                const now = new Date();
                const past = new Date(timestamp);
                const diffMs = now - past;
                const diffMins = Math.floor(diffMs / 60000);
                const diffHours = Math.floor(diffMs / 3600000);
                
                if (diffMins < 1) return 'just now';
                if (diffMins < 60) return `${diffMins} minute${diffMins > 1 ? 's' : ''} ago`;
                return `${diffHours} hour${diffHours > 1 ? 's' : ''} ago`;
            };

            // Update mock presence with time passing
            for (const userId in mockPresence) {
                if (!mockPresence[userId].isOnline && mockPresence[userId].lastSeen) {
                    updateButtonTime(userId, timeAgo(mockPresence[userId].lastSeen));
                }
            }
            
            if (currentUser) {
                updateStatusDisplay();
            }
            logPresence('Time simulation updated');
        }

        function updateButtonTime(userId, timeAgo) {
            const userButtons = document.querySelectorAll('.user-buttons button');
            userButtons.forEach(button => {
                if (button.getAttribute('data-user') === userId) {
                    const originalText = button.getAttribute('data-original-text') || `Chat as: ${userId}`;
                    if (!button.getAttribute('data-original-text')) {
                        button.setAttribute('data-original-text', originalText);
                    }
                    button.textContent = `${originalText} (${timeAgo})`;
                }
            });
        }

        function updatePresenceDisplay() {
            const userButtons = document.querySelectorAll('.user-buttons button');
            
            userButtons.forEach(button => {
                const userId = button.getAttribute('data-user');
                const presence = mockPresence[userId];
                
                if (!presence.isOnline && presence.lastSeen) {
                    updateButtonTime(userId, getTimeAgo(presence.lastSeen));
                } else if (presence.isOnline) {
                    const originalText = button.getAttribute('data-original-text') || `Chat as: ${userId}`;
                    button.textContent = originalText;
                }
            });
            
            if (currentUser) {
                updateStatusDisplay();
            }
        }

        function updateStatusDisplay() {
            const otherUser = currentUser === 'i' ? 'x' : 'i';
            const otherUserStatus = document.getElementById('other-user-status');
            const otherPresence = mockPresence[otherUser];
            
            if (otherPresence) {
                if (otherPresence.isOnline) {
                    otherUserStatus.textContent = 'Online';
                    otherUserStatus.className = 'status-online';
                } else {
                    otherUserStatus.textContent = getTimeAgo(otherPresence.lastSeen) || 'Offline';
                    otherUserStatus.className = 'status-offline';
                }
            }
        }

        function getTimeAgo(timestamp) {
            if (!timestamp) return null;
            const now = new Date();
            const past = new Date(timestamp);
            const diffMs = now - past;
            const diffMins = Math.floor(diffMs / 60000);
            const diffHours = Math.floor(diffMs / 3600000);
            const diffDays = Math.floor(diffMs / 86400000);
            
            if (diffMins < 1) return 'just now';
            if (diffMins < 60) return `${diffMins} minute${diffMins > 1 ? 's' : ''} ago`;
            if (diffHours < 24) return `${diffHours} hour${diffHours > 1 ? 's' : ''} ago`;
            return `${diffDays} day${diffDays > 1 ? 's' : ''} ago`;
        }

        function clearSimulation() {
            mockPresence = {
                'i': { isOnline: false, lastSeen: null },
                'x': { isOnline: false, lastSeen: null }
            };
            
            // Reset buttons
            const userButtons = document.querySelectorAll('.user-buttons button');
            userButtons.forEach(button => {
                const originalText = button.getAttribute('data-original-text');
                if (originalText) {
                    button.textContent = originalText;
                    button.removeAttribute('data-original-text');
                }
            });
            
            document.getElementById('presence-log').innerHTML = '<div>Presence log cleared...</div>';
            logPresence('Simulation reset');
        }

        function setupUserSelection() {
            const userButtons = document.querySelectorAll('.user-buttons button');
            
            userButtons.forEach((button) => {
                button.addEventListener('click', () => {
                    const selectedUser = button.getAttribute('data-user');
                    currentUser = selectedUser;
                    
                    const selectionScreen = document.getElementById('initial-user-selection');
                    const chatContainer = document.getElementById('chat-container');
                    const currentUserDisplay = document.getElementById('my-user-id-display');
                    
                    selectionScreen.style.display = 'none';
                    chatContainer.style.display = 'flex';
                    currentUserDisplay.textContent = currentUser;
                    
                    updateStatusDisplay();
                    logPresence(`You are now chatting as '${selectedUser}'`);
                });
            });
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            setupUserSelection();
            logPresence('Presence test initialized');
            
            // Start time simulation updates every 30 seconds
            simulationInterval = setInterval(simulateTimePass, 30000);
        });
    </script>
</body>
</html>